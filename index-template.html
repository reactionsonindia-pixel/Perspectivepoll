<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- All original meta tags and links are preserved -->
    <title>Perspective Poll - Vote on Today's Hottest Topics</title>
    <meta name="description" content="Cast your vote on today's hottest topics. Explore different perspectives on technology, society, and more. See live results and share your opinion on Perspective Poll.">
    <meta property="og:title" content="Perspective Poll - Vote on Today's Hottest Topics">
    <meta property="og:image" content="https://images.pexels.com/photos/326576/pexels-photo-326576.jpeg?auto=compress&cs=tinysrgb&w=1200">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- All original styles are preserved from your ind2.html file -->
    <style>
        :root {
            --color-bg: #f7f8fa;
            --color-text-primary: #1a202c;
            --color-text-secondary: #718096;
            --color-surface: #ffffff;
            --color-surface-hover: #f1f5f9;
            --color-border: #e2e8f0;
            --color-primary-accent-text: #3b82f6;
            --color-primary-accent-bg: #ddeafe;
            --color-hero-bg-start: rgba(247, 248, 250, 0.95);
            --color-hero-bg-end: rgba(247, 248, 250, 1);
            --color-glass-bg: rgba(255, 255, 255, 0.7);
            --color-glass-border: rgba(0, 0, 0, 0.1);
            --color-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --color-tab-active-border: #3b82f6;
            --color-tab-active-text: #3b82f6;
        }
        html.dark {
            --color-bg: #1a202c;
            --color-text-primary: #f7fafc;
            --color-text-secondary: #a0aec0;
            --color-surface: #2d3748;
            --color-surface-hover: #4a5568;
            --color-border: #4a5568;
            --color-primary-accent-text: #63b3ed;
            --color-primary-accent-bg: #2b6cb0;
            --color-hero-bg-start: rgba(26, 32, 44, 0.95);
            --color-hero-bg-end: rgba(26, 32, 44, 1);
            --color-glass-bg: rgba(45, 55, 72, 0.7);
            --color-glass-border: rgba(255, 255, 255, 0.2);
            --color-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            --color-tab-active-border: #60a5fa;
            --color-tab-active-text: #60a5fa;
        }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); }
        h1, h2, h3 { font-family: 'Lora', serif; }
        .topic-card { transition: transform 0.3s ease, box-shadow 0.3s ease; background-color: var(--color-surface); border: 1px solid var(--color-border); text-decoration: none; }
        .topic-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: var(--color-shadow); }
        .category-tab { transition: all 0.2s ease-in-out; flex-shrink: 0; }
        .category-tab:not(.active):hover { transform: scale(1.05); background-color: var(--color-surface-hover); }
        .category-tab.active { color: white; background-image: linear-gradient(to right, #3b82f6, #60a5fa); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hero-bg { background-image: linear-gradient(var(--color-hero-bg-start), var(--color-hero-bg-end)), url('https://images.pexels.com/photos/207247/pexels-photo-207247.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2'); background-size: cover; background-position: center; }
        .animated-gradient-text { background: linear-gradient(90deg, #14b8a6, #3b82f6, #6366f1, #14b8a6); background-size: 200% 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-animation 4s ease infinite; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .topic-card-description { max-height: 5rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; }
        .subcategory-tag { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--color-primary-accent-text); background-color: var(--color-primary-accent-bg); border-radius: 9999px; }
        .subcategory-wrapper { position: relative; }
        .subcategory-scroll-container { display: flex; gap: 1.5rem; overflow-x: auto; padding: 0.5rem; margin: -0.5rem; scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .subcategory-wrapper .topic-card { width: 300px; flex-shrink: 0; scroll-snap-align: start; }
        .scroll-arrow { position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; width: 2.5rem; height: 2.5rem; border-radius: 9999px; background-color: var(--color-surface); box-shadow: var(--color-shadow); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; pointer-events: none; }
        .scroll-arrow:hover { transform: translateY(-50%) scale(1.1); }
        .scroll-arrow.visible { opacity: 1; pointer-events: auto; }
        .scroll-arrow.left { left: -1.25rem; }
        .scroll-arrow.right { right: -1.25rem; }
        .modal-container { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); transform: scale(0.95); }
        .theme-toggle-dot { transition: transform 0.3s ease; }
        .glassmorphism { background: var(--color-glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--color-glass-border); }
        .like-button .heart-filled { display: none; }
        .like-button.liked .heart-filled { display: inline-block; }
        .like-button.liked .heart-outline { display: none; }
        #scroll-fade-indicator { position: absolute; top: 0; right: 0; bottom: 0; width: 5rem; background: linear-gradient(to left, var(--color-bg), transparent); pointer-events: none; transition: opacity 0.3s ease; }
        
        /* Profile History Styles */
        .profile-tab.active {
            border-color: var(--color-tab-active-border);
            color: var(--color-tab-active-text);
            background-color: var(--color-surface-hover);
        }
        .profile-content-panel.hidden { display: none; }
    </style>
</head>
<body class="text-[var(--color-text-primary)] transition-colors duration-300">

    <div class="w-full min-h-screen flex flex-col items-center">
        
        <!-- MAIN CONTENT CONTAINER -->
        <div id="app-container" class="w-full">
            <main id="topic-selection-container" class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                
                <header class="text-center my-8 py-8 sm:py-12 px-4 sm:px-6 hero-bg rounded-3xl shadow-lg relative overflow-hidden">
                    <h1 class="text-3xl sm:text-5xl md:text-6xl font-extrabold text-[var(--color-text-primary)] tracking-tight">
                        <span class="animated-gradient-text">Perspective Poll</span>
                    </h1>
                    <p class="text-[var(--color-text-secondary)] mt-3 max-w-2xl mx-auto text-base sm:text-lg">Explore diverse topics, consider every angle, and cast your vote.</p>
                </header>

                <div class="mb-8 flex flex-row items-center gap-2 sm:gap-4">
                     <div class="relative flex-grow">
                        <input type="search" id="search-box" placeholder="Search topics..." class="w-full py-3 pl-10 pr-10 text-sm sm:text-base text-[var(--color-text-secondary)] placeholder:text-[var(--color-text-secondary)]/70 bg-[var(--color-surface)] rounded-full border-2 border-[var(--color-border)]/50 focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all shadow-md">
                    </div>
                     <button id="settings-btn" aria-label="Open settings" class="flex-shrink-0 w-11 h-11 sm:w-12 sm:h-12 rounded-full bg-[var(--color-surface)] border-2 border-[var(--color-border)]/50 flex items-center justify-center text-[var(--color-text-secondary)] hover:text-blue-500 dark:hover:text-blue-400 transition-colors shadow-sm hover:shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                     <div class="flex-shrink-0">
                        <button id="sign-in-btn" class="w-full sm:w-auto bg-[var(--color-surface)] border-2 border-[var(--color-border)]/50 hover:bg-[var(--color-surface-hover)] text-[var(--color-text-secondary)] font-semibold py-2.5 px-4 rounded-full transition-all shadow-sm flex items-center gap-2">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.651-3.358-11.297-7.962l-6.571,4.819C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.988,36.586,44,30.861,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                            <span class="hidden sm:inline">Sign in</span>
                        </button>
                        <div id="user-profile-container" class="relative">
                            <div id="user-profile" class="hidden items-center gap-3 relative">
                               <img id="user-photo" class="w-10 h-10 rounded-full cursor-pointer" src="" alt="User photo">
                            </div>
                            <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-[var(--color-surface)] rounded-xl shadow-lg ring-1 ring-black ring-opacity-5 py-1 z-20">
                                <a href="#" id="dropdown-my-profile" class="block px-4 py-2 text-sm text-[var(--color-text-primary)] hover:bg-[var(--color-surface-hover)]">My Profile</a>
                                <a href="#" id="dropdown-sign-out" class="block px-4 py-2 text-sm text-red-500 hover:bg-[var(--color-surface-hover)]">Sign Out</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="main-content-area">
                    <div id="category-container" class="w-full mb-8 relative">
                         <div id="category-tabs" class="flex items-center gap-3 overflow-x-auto hide-scrollbar p-2 rounded-full glassmorphism"></div>
                         <div id="scroll-fade-indicator"></div>
                    </div>
                    <div id="topic-list" class="space-y-8">
                        <!-- Content for Recent, Trending, Categories -->
                    </div>
                    <div id="recent-polls-section">
                         <div id="recent-polls-grid" class="grid md:grid-cols-2 xl:grid-cols-3 gap-6">
                            <!--TOPIC_LIST_PLACEHOLDER-->
                         </div>
                    </div>
                </div>
            </main>
            
            <!-- PROFILE VIEW CONTAINER -->
            <div id="profile-view-container" class="hidden w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <button id="back-to-main-btn" class="mb-6 inline-flex items-center gap-2 text-sm font-semibold text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Back to Polls
                </button>
                <div class="bg-[var(--color-surface)] rounded-2xl shadow-xl p-6 md:p-8">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <img id="profile-view-photo" class="w-24 h-24 rounded-full border-4 border-[var(--color-border)] shadow-md" src="" alt="User photo">
                        <div class="text-center sm:text-left">
                             <h2 id="profile-view-name" class="text-3xl font-bold text-[var(--color-text-primary)]"></h2>
                             <p id="profile-view-email" class="text-md text-[var(--color-text-secondary)]"></p>
                        </div>
                    </div>
            
                    <div class="mt-8 border-b border-[var(--color-border)]">
                        <nav id="profile-view-tabs" class="flex -mb-px space-x-6 overflow-x-auto" aria-label="Tabs">
                            <button class="profile-tab active whitespace-nowrap py-3 px-2 border-b-2 font-semibold text-sm" data-target="liked-polls-content">Liked Polls</button>
                            <button class="profile-tab whitespace-nowrap py-3 px-2 border-b-2 font-semibold text-sm border-transparent text-[var(--color-text-secondary)]" data-target="votes-content">My Votes</button>
                            <button class="profile-tab whitespace-nowrap py-3 px-2 border-b-2 font-semibold text-sm border-transparent text-[var(--color-text-secondary)]" data-target="comments-content">My Comments</button>
                            <button class="profile-tab whitespace-nowrap py-3 px-2 border-b-2 font-semibold text-sm border-transparent text-[var(--color-text-secondary)]" data-target="liked-comments-content">Liked Comments</button>
                        </nav>
                    </div>
            
                    <div class="mt-6 relative min-h-[300px] max-h-[40vh] overflow-y-auto">
                        <div id="liked-polls-content" class="profile-content-panel">
                            <div id="liked-polls-list" class="space-y-4"></div>
                            <p id="no-liked-polls" class="hidden text-center text-[var(--color-text-secondary)] py-12">You haven't liked any polls yet.</p>
                        </div>
                        <div id="votes-content" class="profile-content-panel hidden">
                            <div id="votes-list" class="space-y-4"></div>
                            <p id="no-votes" class="hidden text-center text-[var(--color-text-secondary)] py-12">You haven't voted on any polls yet.</p>
                        </div>
                        <div id="comments-content" class="profile-content-panel hidden">
                            <div id="comments-list" class="space-y-4"></div>
                            <p id="no-comments" class="hidden text-center text-[var(--color-text-secondary)] py-12">You haven't posted any comments yet.</p>
                        </div>
                        <div id="liked-comments-content" class="profile-content-panel hidden">
                            <div id="liked-comments-list" class="space-y-4"></div>
                            <p id="no-liked-comments" class="hidden text-center text-[var(--color-text-secondary)] py-12">You haven't liked any comments yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal-container" class="modal-container fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div id="settings-modal-content" class="modal-content bg-[var(--color-surface)] rounded-2xl shadow-2xl w-full max-w-sm p-8">
            <div class="flex justify-between items-center border-b border-[var(--color-border)] pb-4 mb-6">
                 <h2 class="text-2xl font-bold">Settings</h2>
                 <button id="close-settings-modal-btn" class="text-slate-400 hover:text-slate-600 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                 </button>
            </div>
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-[var(--color-text-primary)]">Theme</span>
                    <div class="flex items-center gap-2">
                        <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <button id="theme-toggle-switch" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-slate-300 dark:bg-slate-600">
                            <span class="theme-toggle-dot inline-block w-4 h-4 transform bg-white rounded-full"></span>
                        </button>
                        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </div>
                </div>
                 <div class="flex justify-between items-center">
                    <span class="font-semibold text-[var(--color-text-primary)]">Font Size</span>
                    <div class="flex items-center gap-1 bg-[var(--color-surface-secondary)] border border-[var(--color-border)]/50 rounded-full shadow-sm p-1">
                        <button id="font-decrease-btn" class="w-10 h-10 rounded-full flex items-center justify-center text-[var(--color-text-secondary)] hover:bg-[var(--color-surface-hover)] transition-colors text-xs font-bold">A-</button>
                        <button id="font-reset-btn" class="w-10 h-10 rounded-full flex items-center justify-center text-[var(--color-text-secondary)] hover:bg-[var(--color-surface-hover)] transition-colors text-sm font-bold">A</button>
                        <button id="font-increase-btn" class="w-10 h-10 rounded-full flex items-center justify-center text-[var(--color-text-secondary)] hover:bg-[var(--color-surface-hover)] transition-colors text-base font-bold">A+</button>
                    </div>
                </div>
            </div>
             <button id="settings-done-btn" class="mt-8 w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700">Done</button>
        </div>
    </div>
    
    <!-- AUTH PROMPT MODAL -->
    <div id="auth-modal-container" class="modal-container fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div id="auth-modal-content" class="modal-content bg-[var(--color-surface)] rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center">
            <h2 class="text-2xl font-bold text-[var(--color-text-primary)]">Sign In Required</h2>
            <p class="text-[var(--color-text-secondary)] mt-2">Please sign in to like polls and participate in the community.</p>
            <div class="mt-6 flex gap-4">
                <button id="auth-modal-close-btn" class="w-full bg-[var(--color-surface-hover)] text-[var(--color-text-secondary)] font-semibold py-2.5 rounded-lg hover:bg-[var(--color-border)] transition-colors">Cancel</button>
                <button id="auth-modal-signin-btn" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 transition-colors">Sign In</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, setDoc, deleteDoc, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
              apiKey: "AIzaSyDU6kTkg1RasSDQyAr1MOXEyJj3dqcZ45k",
              authDomain: "my-perspective-poll.firebaseapp.com",
              projectId: "my-perspective-poll",
              storageBucket: "my-perspective-poll.appspot.com",
              messagingSenderId: "223184083932",
              appId: "1:223184083932:web:1e216a3be5990c90710d19"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            let topicsData = {};
            let allTopicsFlat = [];
            let recentTopicsFlat = []; 
            let userLikedTopics = new Set();
            let userVotes = new Map(); // topicId -> perspectiveText
            let trendingTopics = [];
            let currentTrendingPage = 1;
            const TOPICS_PER_PAGE = 4;
            
            // Promise to ensure main data is loaded before profile tries to access it
            let dataReadyPromiseResolve;
            const dataReadyPromise = new Promise(resolve => {
                dataReadyPromiseResolve = resolve;
            });

            const appContainer = document.getElementById('app-container');
            const recentPollsGrid = document.getElementById('recent-polls-grid');
            const preRenderedCount = recentPollsGrid.children.length;

            const topicList = document.getElementById('topic-list');
            const categoryTabsContainer = document.getElementById('category-tabs');
            const scrollFadeIndicator = document.getElementById('scroll-fade-indicator');
            const recentPollsSection = document.getElementById('recent-polls-section');
            const signInBtn = document.getElementById('sign-in-btn');
            const userProfile = document.getElementById('user-profile');
            const userDropdown = document.getElementById('user-dropdown');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModalContainer = document.getElementById('settings-modal-container');
            const settingsModalContent = document.getElementById('settings-modal-content');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
            const settingsDoneBtn = document.getElementById('settings-done-btn');
            const themeToggleSwitch = document.getElementById('theme-toggle-switch');
            const fontDecreaseBtn = document.getElementById('font-decrease-btn');
            const fontResetBtn = document.getElementById('font-reset-btn');
            const fontIncreaseBtn = document.getElementById('font-increase-btn');
            const searchBox = document.getElementById('search-box');
            
            // Profile View Elements
            const mainContainer = document.getElementById('topic-selection-container');
            const profileViewContainer = document.getElementById('profile-view-container');
            const backToMainBtn = document.getElementById('back-to-main-btn');
            const profileViewTabs = document.getElementById('profile-view-tabs');
            const profileViewPhoto = document.getElementById('profile-view-photo');
            const profileViewName = document.getElementById('profile-view-name');
            const profileViewEmail = document.getElementById('profile-view-email');
            
            // Auth Prompt Modal Elements
            const authModalContainer = document.getElementById('auth-modal-container');
            const authModalContent = document.getElementById('auth-modal-content');
            const authModalCloseBtn = document.getElementById('auth-modal-close-btn');
            const authModalSigninBtn = document.getElementById('auth-modal-signin-btn');

            function slugify(text) {
                if (typeof text !== 'string') return 'untitled-topic';
                const a = 'Ã Ã¡Ã¢Ã¤Ã¦Ã£Ã¥ÄÄƒÄ…Ã§Ä‡ÄÄ‘ÄÃ¨Ã©ÃªÃ«Ä“Ä—Ä™Ä›ÄŸÇµá¸§Ã®Ã¯Ã­Ä«Ä¯Ã¬Å‚á¸¿Ã±Å„Ç¹ÅˆÃ´Ã¶Ã²Ã³Å“Ã¸ÅÃµÅ‘á¹•Å•Å™ÃŸÅ›Å¡ÅŸÈ™Å¥È›Ã»Ã¼Ã¹ÃºÅ«Ç˜Å¯Å±Å³áºƒáºÃ¿Ã½Å¾ÅºÅ¼Â·/_,:;'
                const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
                const p = new RegExp(a.split('').join('|'), 'g')
                return text.toString().toLowerCase().replace(/\s+/g, '-').replace(p, c => b.charAt(a.indexOf(c))).replace(/&/g, '-and-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
            }

            function createTopicCard(topic, unlikeCallback) {
                const slug = slugify(topic.title);
                const link = `/topics/${slug}.html?id=${topic.id}&category=${encodeURIComponent(topic.category)}&subcategory=${encodeURIComponent(topic.subcategory)}`;
                
                const totalVotes = topic.perspectives ? Object.values(topic.perspectives).reduce((sum, p) => sum + p.votes, 0) : 0;
                const firstImage = topic.media && topic.media.find(item => item.type === 'image');
                const imageUrl = firstImage ? firstImage.url : `https://placehold.co/600x400/e2e8f0/64748b?text=${encodeURIComponent(topic.title)}`;
                const isLiked = userLikedTopics.has(topic.id);
                
                // Check if user voted on this topic
                const userVote = userVotes.get(topic.id);

                const card = document.createElement('a');
                card.href = link;
                card.className = 'topic-card rounded-2xl shadow-lg flex flex-col';
                card.dataset.topicId = topic.id;
                
                // Only show vote info if user voted
                let voteInfo = '';
                if(userVote) {
                    voteInfo = `<div class="vote-info text-xs text-center p-2 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-b-2xl -mt-2"><p>You voted for: <span class="font-semibold">${userVote}</span></p></div>`
                }

                card.innerHTML = `
                    <div class="relative pt-[56.25%] rounded-t-2xl overflow-hidden"><img src="${imageUrl}" alt="${topic.title}" class="absolute top-0 left-0 w-full h-full object-cover" loading="lazy"></div>
                    <div class="p-4 flex-grow flex flex-col">
                        <div><span class="subcategory-tag">${topic.subcategory}</span></div>
                        <h3 class="font-bold text-lg mt-2">${topic.title}</h3>
                        <p class="topic-card-description text-sm text-[var(--color-text-secondary)] mt-2">${topic.description}</p>
                    </div>
                    <div class="px-4 pb-4 border-t border-[var(--color-border)]/50 flex justify-between items-center mt-auto pt-3">
                        <div class="flex items-center gap-4 text-sm text-[var(--color-text-secondary)]">
                            <button class="like-button flex items-center gap-1.5 hover:text-red-500 ${isLiked ? 'liked' : ''}">
                                <svg class="heart-outline w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                                <svg class="heart-filled w-5 h-5 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9.653 16.915l-.005-.003-.019-.01a20.759 20.759 0 01-1.162-.682 22.045 22.045 0 01-2.582-1.9-22.247 22.247 0 01-2.644-2.437 24.362 24.362 0 01-1.644-2.296C1.025 6.42 2.342 4.148 4.793 4.148c1.393 0 2.68.723 3.432 1.855c.753-1.132 2.04-1.855 3.433-1.855c2.45 0 3.768 2.272 3.22 5.263c-.538 2.957-2.956 5.395-5.948 7.532a24.394 24.394 0 01-1.644 1.037z" /></svg>
                                <span class="like-count font-medium">${topic.likes || 0}</span>
                            </button>
                            <span class="flex items-center gap-1.5">
                                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                <span>${totalVotes}</span>
                            </span>
                        </div>
                        <div class="text-sm font-bold text-[var(--color-primary-accent-text)] group">
                            Explore Now <span class="inline-block transition-transform group-hover:translate-x-1">&rarr;</span>
                        </div>
                    </div>
                    ${voteInfo}
                `;

                attachLikeListenerToCard(card, topic, unlikeCallback);
                return card;
            }

            function attachLikeListenerToCard(cardElement, topicData, unlikeCallback) {
                const likeButton = cardElement.querySelector('.like-button');
                if (likeButton && !likeButton.dataset.listenerAttached) {
                    likeButton.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        likeTopic(topicData, likeButton, unlikeCallback);
                    });
                    likeButton.dataset.listenerAttached = 'true';
                }
            }

            function updateAllVisibleVoteInfo() {
                document.querySelectorAll('.topic-card').forEach(card => {
                    const topicId = card.dataset.topicId;
                    const userVote = userVotes.get(topicId);
                    const existingVoteInfo = card.querySelector('.vote-info');
                    
                    if (userVote) {
                        if (!existingVoteInfo) {
                            const voteInfoDiv = document.createElement('div');
                            voteInfoDiv.className = 'vote-info text-xs text-center p-2 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-b-2xl -mt-2';
                            voteInfoDiv.innerHTML = `<p>You voted for: <span class="font-semibold">${userVote}</span></p>`;
                            card.appendChild(voteInfoDiv);
                        } else {
                            existingVoteInfo.innerHTML = `<p>You voted for: <span class="font-semibold">${userVote}</span></p>`;
                        }
                    } else if (existingVoteInfo) {
                        existingVoteInfo.remove();
                    }
                });
            }

            function handleSearch(event) {
                const query = event.target.value.toLowerCase().trim();
                
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));

                if (!query) {
                    topicList.style.display = 'none';
                    topicList.innerHTML = '';
                    recentPollsSection.style.display = 'block';
                    const recentTab = Array.from(document.querySelectorAll('.category-tab')).find(tab => tab.textContent.includes('Recent'));
                    if(recentTab) recentTab.classList.add('active');
                    return;
                }

                const searchResults = allTopicsFlat.filter(topic => 
                    topic.title.toLowerCase().includes(query) || 
                    topic.description.toLowerCase().includes(query)
                );
                
                recentPollsSection.style.display = 'none';
                topicList.innerHTML = '';
                topicList.style.display = 'block';
                
                const heading = document.createElement('h2');
                heading.className = "text-2xl font-bold border-b-2 border-blue-200 dark:border-blue-800 pb-2 mb-4";
                heading.textContent = `Search Results for "${event.target.value}"`;
                topicList.appendChild(heading);

                const grid = document.createElement('div');
                grid.className = "grid md:grid-cols-2 xl:grid-cols-3 gap-6";

                if (searchResults.length > 0) {
                    searchResults.forEach(topic => {
                        grid.appendChild(createTopicCard(topic));
                    });
                } else {
                    grid.innerHTML = `<p class="text-center text-[var(--color-text-secondary)] col-span-full">No topics found matching your search term.</p>`;
                }
                topicList.appendChild(grid);
            }

            function renderTrendingTopics(isInitial = false) {
                if (isInitial) {
                    currentTrendingPage = 1;
                }
                const topicListContainer = document.getElementById('topic-list');
                let grid;
                let loadMoreContainer;

                if (isInitial) {
                    topicListContainer.innerHTML = ''; 

                    const heading = document.createElement('h2');
                    heading.className = "text-2xl font-bold border-b-2 border-blue-200 dark:border-blue-800 pb-2 mb-4";
                    heading.textContent = "Trending Polls";
                    topicListContainer.appendChild(heading);

                    grid = document.createElement('div');
                    grid.className = "grid md:grid-cols-2 xl:grid-cols-3 gap-6";
                    grid.id = 'trending-polls-grid';
                    topicListContainer.appendChild(grid);

                    loadMoreContainer = document.createElement('div');
                    loadMoreContainer.id = 'trending-load-more';
                    loadMoreContainer.className = 'text-center py-8';
                    topicListContainer.appendChild(loadMoreContainer);

                } else {
                    grid = document.getElementById('trending-polls-grid');
                    loadMoreContainer = document.getElementById('trending-load-more');
                }

                const startIndex = (currentTrendingPage - 1) * TOPICS_PER_PAGE;
                const endIndex = startIndex + TOPICS_PER_PAGE;
                const topicsToDisplay = trendingTopics.slice(startIndex, endIndex);

                if (isInitial && topicsToDisplay.length === 0) {
                    grid.innerHTML = `<p class="text-center text-[var(--color-text-secondary)] col-span-full">Not enough activity to determine trends yet. Vote on some polls!</p>`;
                    return;
                }

                topicsToDisplay.forEach(topic => {
                    grid.appendChild(createTopicCard(topic));
                });

                loadMoreContainer.innerHTML = ''; 
                if (endIndex < trendingTopics.length) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.textContent = 'Load More Trending Polls';
                    loadMoreBtn.className = 'bg-indigo-600 text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5';
                    loadMoreBtn.addEventListener('click', () => {
                        currentTrendingPage++;
                        renderTrendingTopics();
                    });
                    loadMoreContainer.appendChild(loadMoreBtn);
                }
            }
            
            function attachListenersToPreRenderedCards() {
                const preRenderedCards = recentPollsGrid.querySelectorAll('.topic-card');
                preRenderedCards.forEach(card => {
                    const topicId = card.dataset.topicId;
                    const topicData = allTopicsFlat.find(t => t.id === topicId);
                    if (topicData) {
                        attachLikeListenerToCard(card, topicData);
                    }
                });
            }

            async function fetchAndPrepareData() {
                try {
                    const categoriesSnapshot = await getDocs(collection(db, 'categories'));
                    for (const categoryDoc of categoriesSnapshot.docs) {
                        const subcategoriesRef = collection(db, 'categories', categoryDoc.id, 'subcategories');
                        const subcategoriesSnapshot = await getDocs(subcategoriesRef);
                        topicsData[categoryDoc.id] = { subcategories: {} };
                        for (const subcategoryDoc of subcategoriesSnapshot.docs) {
                             const topicsQuery = query(collection(db, 'categories', categoryDoc.id, 'subcategories', subcategoryDoc.id, 'topics'), orderBy('timestamp', 'desc'));
                            const topicsSnapshot = await getDocs(topicsQuery);
                            topicsData[categoryDoc.id].subcategories[subcategoryDoc.id] = {};
                             topicsSnapshot.forEach(topicDoc => {
                                const topicData = topicDoc.data();
                                topicsData[categoryDoc.id].subcategories[subcategoryDoc.id][topicDoc.id] = topicData;
                                allTopicsFlat.push({ ...topicData, id: topicDoc.id, category: categoryDoc.id, subcategory: subcategoryDoc.id });
                            });
                        }
                    }
                    allTopicsFlat.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                    
                    recentTopicsFlat = allTopicsFlat;
                    
                    attachListenersToPreRenderedCards();
                    renderCategoryTabs();
                    
                    // Render any recent polls that weren't pre-rendered
                    const topicsToRenderClientSide = recentTopicsFlat.slice(preRenderedCount);
                    topicsToRenderClientSide.forEach(topic => {
                        recentPollsGrid.appendChild(createTopicCard(topic));
                    });

                } catch (error) {
                    console.error("Error fetching dynamic data:", error);
                } finally {
                    dataReadyPromiseResolve();
                }
            }

            function renderCategoryTabs() {
                categoryTabsContainer.innerHTML = '';
                const recentTab = document.createElement('button');
                recentTab.className = 'category-tab font-semibold py-2 px-5 rounded-full text-[var(--color-text-secondary)] active';
                recentTab.onclick = () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    recentTab.classList.add('active');
                    topicList.innerHTML = '';
                    topicList.style.display = 'none';
                    recentPollsSection.style.display = 'block';
                };
                recentTab.textContent = 'âœ¨ Recent';
                categoryTabsContainer.appendChild(recentTab);
                
                const trendingTab = document.createElement('button');
                trendingTab.className = 'category-tab font-semibold py-2 px-5 rounded-full text-[var(--color-text-secondary)]';
                trendingTab.innerHTML = `ðŸ”¥ Trending`;
                trendingTab.onclick = () => showTrendingTopics(trendingTab);
                categoryTabsContainer.appendChild(trendingTab);

                Object.keys(topicsData).forEach(category => {
                    const tab = document.createElement('button');
                    tab.className = 'category-tab font-semibold py-2 px-5 rounded-full text-[var(--color-text-secondary)]';
                    tab.textContent = category;
                    tab.onclick = () => filterByCategory(category, tab);
                    categoryTabsContainer.appendChild(tab);
                });
            }

            function showTrendingTopics(activeTab) {
                document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                if (activeTab) activeTab.classList.add('active');
                recentPollsSection.style.display = 'none';
                topicList.style.display = 'block';
                topicList.innerHTML = '';

                const now = new Date().getTime() / 1000;
                const gravity = 1.8;

                const scoredTopics = allTopicsFlat.map(topic => {
                    const totalVotes = topic.perspectives ? Object.values(topic.perspectives).reduce((sum, p) => sum + p.votes, 0) : 0;
                    const totalLikes = topic.likes || 0;
                    const totalEngagement = (totalVotes * 2) + totalLikes;
                    const pollTimestamp = topic.timestamp?.seconds || now;
                    const ageInHours = (now - pollTimestamp) / 3600;
                    const trendScore = totalEngagement / Math.pow(ageInHours + 2, gravity);
                    return { ...topic, trendScore };
                });

                scoredTopics.sort((a, b) => b.trendScore - a.trendScore);
                trendingTopics = scoredTopics;
                renderTrendingTopics(true);
            }

            function filterByCategory(category, activeTab) {
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                if(activeTab) activeTab.classList.add('active');
                recentPollsSection.style.display = 'none';
                topicList.style.display = 'block';
                topicList.innerHTML = '';

                for (const subcategoryName in topicsData[category].subcategories) {
                    const subcategoryHeading = document.createElement('h2');
                    subcategoryHeading.className = "text-2xl font-bold border-b-2 border-blue-200 dark:border-blue-800 pb-2 mb-4";
                    subcategoryHeading.textContent = subcategoryName;
                    topicList.appendChild(subcategoryHeading);

                    const wrapper = document.createElement('div');
                    wrapper.className = 'relative mb-8 subcategory-wrapper';

                    const scrollContainer = document.createElement('div');
                    scrollContainer.className = 'flex gap-6 overflow-x-auto hide-scrollbar pb-4 subcategory-scroll-container';
                    
                    const arrowLeft = document.createElement('button');
                    arrowLeft.className = 'scroll-arrow left';
                    arrowLeft.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>`;
                    
                    const arrowRight = document.createElement('button');
                    arrowRight.className = 'scroll-arrow right';
                    arrowRight.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>`;

                    const topicsInSubcategory = topicsData[category].subcategories[subcategoryName];
                    Object.keys(topicsInSubcategory).forEach(topicId => {
                        const topic = topicsInSubcategory[topicId];
                        const card = createTopicCard({ ...topic, id: topicId, category: category, subcategory: subcategoryName });
                        scrollContainer.appendChild(card);
                    });
                    
                    wrapper.appendChild(scrollContainer);
                    wrapper.appendChild(arrowLeft);
                    wrapper.appendChild(arrowRight);
                    topicList.appendChild(wrapper);

                    const manageArrows = () => {
                        const isScrollable = scrollContainer.scrollWidth > scrollContainer.clientWidth;
                        arrowLeft.classList.toggle('visible', isScrollable && scrollContainer.scrollLeft > 10);
                        arrowRight.classList.toggle('visible', isScrollable && scrollContainer.scrollLeft < scrollContainer.scrollWidth - scrollContainer.clientWidth - 10);
                    };
                    
                    arrowLeft.onclick = () => scrollContainer.scrollBy({ left: -320, behavior: 'smooth' });
                    arrowRight.onclick = () => scrollContainer.scrollBy({ left: 320, behavior: 'smooth' });

                    scrollContainer.addEventListener('scroll', manageArrows);
                    new ResizeObserver(manageArrows).observe(scrollContainer);
                    setTimeout(manageArrows, 150);
                }
            }
            
             async function likeTopic(topic, buttonElement, unlikeCallback) {
                if (!auth.currentUser) {
                    openModal(authModalContainer, authModalContent);
                    return;
                }
                const user = auth.currentUser;
                const topicRef = doc(db, 'categories', topic.category, 'subcategories', topic.subcategory, 'topics', topic.id);
                const userLikeRef = doc(db, 'users', user.uid, 'likes', topic.id);
                const isLiked = userLikedTopics.has(topic.id);
                
                const countElement = buttonElement.querySelector('.like-count');
                let currentCount = parseInt(countElement.textContent);

                buttonElement.classList.toggle('liked');
                if (isLiked) {
                    userLikedTopics.delete(topic.id);
                    const newCount = Math.max(0, currentCount - 1);
                    countElement.textContent = newCount;
                    if(unlikeCallback) unlikeCallback(topic.id);
                } else {
                    userLikedTopics.add(topic.id);
                    countElement.textContent = currentCount + 1;
                }
                
                try {
                    const incrementValue = increment(isLiked ? -1 : 1);
                    const topicDataForLike = { title: topic.title, category: topic.category, subcategory: topic.subcategory, timestamp: new Date()};
                    if (isLiked) {
                        await updateDoc(topicRef, { likes: incrementValue });
                        await deleteDoc(userLikeRef);
                    } else {
                        await updateDoc(topicRef, { likes: incrementValue });
                        await setDoc(userLikeRef, topicDataForLike);
                    }
                } catch (e) {
                    console.error("Like failed: ", e);
                     buttonElement.classList.toggle('liked');
                     countElement.textContent = currentCount;
                     isLiked ? userLikedTopics.add(topic.id) : userLikedTopics.delete(topic.id);
                }
            }

            function updateAllVisibleLikeButtons() {
                document.querySelectorAll('.topic-card').forEach(card => {
                    const topicId = card.dataset.topicId;
                    const likeButton = card.querySelector('.like-button');
                    if (topicId && likeButton) {
                        likeButton.classList.toggle('liked', userLikedTopics.has(topicId));
                    }
                });
            }

            function openModal(modalContainer, modalContent) {
                modalContainer.classList.remove('hidden');
                setTimeout(() => { modalContainer.classList.remove('opacity-0'); modalContent.style.transform = 'scale(1)'; }, 10);
            }
            function closeModal(modalContainer, modalContent) {
                modalContainer.classList.add('opacity-0');
                modalContent.style.transform = 'scale(0.95)';
                setTimeout(() => { modalContainer.classList.add('hidden'); }, 300);
            }
            function applyInitialTheme() {
                const isDark = localStorage.getItem('theme') === 'dark';
                document.documentElement.classList.toggle('dark', isDark);
                themeToggleSwitch.querySelector('.theme-toggle-dot').style.transform = isDark ? 'translateX(1.25rem)' : 'translateX(0)';
            }
            function handleThemeToggle() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                themeToggleSwitch.querySelector('.theme-toggle-dot').style.transform = isDark ? 'translateX(1.25rem)' : 'translateX(0)';
            }
            const FONT_SIZES = [12, 14, 16, 18, 20];
            const DEFAULT_FONT_INDEX = 2;
            function applyInitialFontSize() {
                const savedSize = localStorage.getItem('fontSize');
                document.documentElement.style.fontSize = `${savedSize || FONT_SIZES[DEFAULT_FONT_INDEX]}px`;
            }
            function changeFontSize(direction) {
                 const currentSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
                let currentIndex = FONT_SIZES.findIndex(size => size === currentSize);
                if (currentIndex === -1) currentIndex = DEFAULT_FONT_INDEX;
                let newIndex = currentIndex + direction;
                if (newIndex >= 0 && newIndex < FONT_SIZES.length) {
                    const newSize = FONT_SIZES[newIndex];
                    document.documentElement.style.fontSize = `${newSize}px`;
                    localStorage.setItem('fontSize', newSize);
                }
            }
            function resetFontSize() {
                const defaultSize = FONT_SIZES[DEFAULT_FONT_INDEX];
                document.documentElement.style.fontSize = `${defaultSize}px`;
                localStorage.setItem('fontSize', defaultSize);
            }
            settingsBtn.addEventListener('click', () => openModal(settingsModalContainer, settingsModalContent));
            closeSettingsModalBtn.addEventListener('click', () => closeModal(settingsModalContainer, settingsModalContent));
            settingsDoneBtn.addEventListener('click', () => closeModal(settingsModalContainer, settingsModalContent));
            themeToggleSwitch.addEventListener('click', handleThemeToggle);
            fontDecreaseBtn.addEventListener('click', () => changeFontSize(-1));
            fontResetBtn.addEventListener('click', resetFontSize);
            fontIncreaseBtn.addEventListener('click', () => changeFontSize(1));
            applyInitialTheme();
            applyInitialFontSize();
            
            searchBox.addEventListener('input', handleSearch);

            function handleInitialSearch() {
                const params = new URLSearchParams(window.location.search);
                const searchQuery = params.get('search');
                if (searchQuery) {
                    searchBox.value = searchQuery;
                    handleSearch({ target: { value: searchQuery } });
                }
            }

            // --- Profile View and History Logic ---
            function showProfileView() {
                mainContainer.classList.add('hidden');
                profileViewContainer.classList.remove('hidden');
                const user = auth.currentUser;
                if(user) {
                    profileViewPhoto.src = user.photoURL;
                    profileViewName.textContent = user.displayName;
                    profileViewEmail.textContent = user.email;
                    
                    profileViewTabs.querySelectorAll('.profile-tab').forEach(t => {
                        t.classList.remove('active');
                        t.dataset.loaded = "false";
                    });
                     document.querySelectorAll('.profile-content-panel').forEach(p => {
                        p.classList.add('hidden');
                    });
                    
                    const defaultTab = profileViewTabs.querySelector('[data-target="liked-polls-content"]');
                    defaultTab.classList.add('active');
                    document.getElementById('liked-polls-content').classList.remove('hidden');
                    loadProfileHistoryForTab('liked-polls-content');
                }
            }

            function showMainView() {
                profileViewContainer.classList.add('hidden');
                mainContainer.classList.remove('hidden');
            }

            async function loadProfileHistoryForTab(tabId) {
                await dataReadyPromise; // Wait for the main data to be ready
                
                const contentContainer = document.getElementById(tabId);
                const tabButton = profileViewTabs.querySelector(`[data-target="${tabId}"]`);
                if (tabButton.dataset.loaded === 'true') return;

                const user = auth.currentUser;
                let queryRef;
                let renderFunction;

                switch (tabId) {
                    case 'liked-polls-content':
                        queryRef = query(collection(db, 'users', user.uid, 'likes'), orderBy('timestamp', 'desc'));
                        renderFunction = renderLikedPolls;
                        break;
                    case 'votes-content':
                        queryRef = query(collection(db, 'users', user.uid, 'votes'), orderBy('timestamp', 'desc'));
                        renderFunction = renderVotes;
                        break;
                    case 'comments-content':
                        queryRef = query(collection(db, 'users', user.uid, 'comments'), orderBy('timestamp', 'desc'));
                        renderFunction = renderComments;
                        break;
                    case 'liked-comments-content':
                        queryRef = query(collection(db, 'users', user.uid, 'likedComments'), orderBy('timestamp', 'desc'));
                        renderFunction = renderLikedComments;
                        break;
                }

                try {
                    const snapshot = await getDocs(queryRef);
                    renderFunction(snapshot.docs, contentContainer);
                    tabButton.dataset.loaded = 'true';
                } catch (error) {
                    console.error(`Error fetching history for ${tabId}:`, error);
                    contentContainer.querySelector('.space-y-4').innerHTML = `<p class="text-sm text-red-500 text-center col-span-full">Could not load this section.</p>`;
                }
            }
            
            function createPollHistoryItemHTML(doc, topic, userVote) {
                const slug = slugify(topic.title);
                const link = `/topics/${slug}.html?id=${topic.id}&category=${encodeURIComponent(topic.category)}&subcategory=${encodeURIComponent(topic.subcategory)}`;
                let subtext = '';
                if (userVote) {
                    subtext = `<p class="text-xs text-[var(--color-text-secondary)] mt-1">You voted for: <span class="font-medium text-[var(--color-text-primary)]">${userVote}</span></p>`;
                } else {
                    const likeTimestamp = doc.data().timestamp;
                    subtext = `<p class="text-xs text-[var(--color-text-secondary)] mt-1">Liked on ${new Date(likeTimestamp.seconds * 1000).toLocaleDateString()}</p>`;
                }
                
                return `
                    <a href="${link}" class="block p-4 rounded-lg bg-[var(--color-surface-hover)] hover:bg-[var(--color-border)] transition-colors">
                        <p class="font-semibold text-[var(--color-text-primary)]">${topic.title}</p>
                        ${subtext}
                    </a>
                `;
            }

            function renderLikedPolls(docs, container) {
                const list = container.querySelector('#liked-polls-list');
                const emptyMsg = container.querySelector('#no-liked-polls');
                list.innerHTML = '';
                if (docs.length === 0) {
                    emptyMsg.classList.remove('hidden');
                    return;
                }
                 emptyMsg.classList.add('hidden');
                docs.forEach(doc => {
                    const topic = allTopicsFlat.find(t => t.id === doc.id);
                    if(topic) {
                        list.insertAdjacentHTML('beforeend', createPollHistoryItemHTML(doc, topic, null));
                    }
                });
            }

            function renderVotes(docs, container) {
                const list = container.querySelector('#votes-list');
                const emptyMsg = container.querySelector('#no-votes');
                list.innerHTML = '';
                if (docs.length === 0) {
                    emptyMsg.classList.remove('hidden');
                    return;
                }
                emptyMsg.classList.add('hidden');
                docs.forEach(doc => {
                    const topic = allTopicsFlat.find(t => t.id === doc.id);
                    if (topic) {
                        list.insertAdjacentHTML('beforeend', createPollHistoryItemHTML(doc, topic, doc.data().perspectiveText));
                    }
                });
            }
            
            function createCommentHistoryItemHTML(doc) {
                const data = doc.data();
                const slug = slugify(data.topicTitle);
                const link = `/topics/${slug}.html?id=${data.topicId}&category=${encodeURIComponent(data.category)}&subcategory=${encodeURIComponent(data.subcategory)}#comment-${doc.id}`;
                return `
                    <a href="${link}" class="block p-4 rounded-lg bg-[var(--color-surface-hover)] hover:bg-[var(--color-border)] transition-colors">
                        <p class="text-xs text-[var(--color-text-secondary)] mb-1">On poll: <span class="font-semibold text-[var(--color-text-primary)]">${data.topicTitle}</span></p>
                        <p class="text-sm text-[var(--color-text-primary)] pl-2 border-l-2 border-[var(--color-border)]">"${data.text}"</p>
                    </a>
                `;
            }

            function renderComments(docs, container) {
                const list = container.querySelector('#comments-list');
                const emptyMsg = container.querySelector('#no-comments');
                list.innerHTML = '';
                 if (docs.length === 0) {
                    emptyMsg.classList.remove('hidden');
                    return;
                }
                emptyMsg.classList.add('hidden');
                docs.forEach(doc => {
                    list.insertAdjacentHTML('beforeend', createCommentHistoryItemHTML(doc));
                });
            }

            function renderLikedComments(docs, container) {
                const list = container.querySelector('#liked-comments-list');
                const emptyMsg = container.querySelector('#no-liked-comments');
                list.innerHTML = '';
                if (docs.length === 0) {
                    emptyMsg.classList.remove('hidden');
                    return;
                }
                emptyMsg.classList.add('hidden');
                docs.forEach(doc => {
                     list.insertAdjacentHTML('beforeend', createCommentHistoryItemHTML(doc));
                });
            }
            
            profileViewTabs.addEventListener('click', (e) => {
                if (e.target.matches('.profile-tab')) {
                    profileViewTabs.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');

                    const targetId = e.target.dataset.target;
                    document.querySelectorAll('.profile-content-panel').forEach(content => {
                        content.classList.toggle('hidden', content.id !== targetId);
                    });
                    
                    loadProfileHistoryForTab(targetId);
                }
            });

            // Dropdown & View Switching Logic
            userProfile.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle('hidden');
            });
            
            document.addEventListener('click', (e) => {
                if (!userProfile.contains(e.target)) {
                    userDropdown.classList.add('hidden');
                }
            });

            document.getElementById('dropdown-my-profile').addEventListener('click', (e) => {
                e.preventDefault();
                userDropdown.classList.add('hidden');
                showProfileView();
            });

            document.getElementById('dropdown-sign-out').addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth);
                userDropdown.classList.add('hidden');
            });

            backToMainBtn.addEventListener('click', showMainView);

            // Auth Modal Listeners
            signInBtn.addEventListener('click', () => openModal(authModalContainer, authModalContent));
            authModalCloseBtn.addEventListener('click', () => closeModal(authModalContainer, authModalContent));
            authModalSigninBtn.addEventListener('click', () => {
                closeModal(authModalContainer, authModalContent);
                signInWithPopup(auth, new GoogleAuthProvider());
            });

            onAuthStateChanged(auth, async (user) => {
                 if (user) {
                    signInBtn.classList.add('hidden');
                    userProfile.classList.remove('hidden');
                    document.getElementById('user-photo').src = user.photoURL;
                    
                    // Fetch user likes
                    const likesSnapshot = await getDocs(collection(db, 'users', user.uid, 'likes'));
                    userLikedTopics.clear();
                    likesSnapshot.forEach(doc => userLikedTopics.add(doc.id));
                    
                    // Fetch user votes
                    const votesSnapshot = await getDocs(collection(db, 'users', user.uid, 'votes'));
                    userVotes.clear();
                    votesSnapshot.forEach(doc => {
                        userVotes.set(doc.id, doc.data().perspectiveText);
                    });
                    
                    updateAllVisibleLikeButtons();
                    updateAllVisibleVoteInfo();

                } else {
                    signInBtn.classList.remove('hidden');
                    userProfile.classList.add('hidden');
                    userDropdown.classList.add('hidden');
                    userLikedTopics.clear();
                    userVotes.clear();
                    updateAllVisibleLikeButtons();
                    updateAllVisibleVoteInfo();

                    if (!profileViewContainer.classList.contains('hidden')) {
                        showMainView();
                    }
                }
            });
             
            const manageScrollFade = () => {
                const isScrollable = categoryTabsContainer.scrollWidth > categoryTabsContainer.clientWidth;
                const scrollFade = document.getElementById('scroll-fade-indicator');
                if (scrollFade) {
                    scrollFade.style.display = isScrollable ? 'block' : 'none';
                    if (isScrollable) {
                        const scrollPercentage = categoryTabsContainer.scrollLeft / (categoryTabsContainer.scrollWidth - categoryTabsContainer.clientWidth);
                        scrollFade.style.opacity = Math.max(0, 1 - (scrollPercentage * 2));
                    }
                }
            };
            categoryTabsContainer.addEventListener('scroll', manageScrollFade);
            new ResizeObserver(manageScrollFade).observe(categoryTabsContainer);

            fetchAndPrepareData();
            handleInitialSearch();
        });
    </script>
</body>
</html>